<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings and Preferences - Super Scheduler</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fsupersche6116back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
</head>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="bg-surface border-b border-slate-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Brand -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                        </svg>
                        <h1 class="text-xl font-semibold text-text-primary">Super Scheduler</h1>
                    </div>
                </div>

                <!-- Navigation Menu (no Create Event) -->
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="calendar_dashboard.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-calendar-alt mr-2"></i>Dashboard
                    </a>
                    <a href="task_management.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>Tasks
                    </a>
                    <a href="search_and_filter.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-search mr-2"></i>Search
                    </a>
                    <a href="settings_and_preferences.html" class="text-primary font-medium px-3 py-2 rounded-md bg-primary-50">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                </nav>

                <!-- Mobile Menu Button -->
                <button class="md:hidden p-2 rounded-md text-text-secondary hover:text-primary hover:bg-slate-50" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Mobile Navigation Menu (no Create Event) -->
            <div id="mobileMenu" class="md:hidden hidden border-t border-slate-200 py-4">
                <div class="flex flex-col space-y-2">
                    <a href="calendar_dashboard.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-calendar-alt mr-2"></i>Dashboard
                    </a>
                    <a href="task_management.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>Tasks
                    </a>
                    <a href="search_and_filter.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-search mr-2"></i>Search
                    </a>
                    <a href="settings_and_preferences.html" class="text-primary font-medium px-3 py-2 rounded-md bg-primary-50">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Page Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-semibold text-text-primary mb-2">Settings & Preferences</h2>
            <p class="text-text-secondary">Customize your calendar experience and manage your preferences</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Settings Navigation Sidebar -->
            <aside class="lg:w-80 order-2 lg:order-1">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Settings Menu</h3>
                    <nav class="space-y-2">
                        <button onclick="showSection('display', this)" class="settings-nav-btn active w-full text-left px-3 py-2 rounded-md transition-colors">
                            <i class="fas fa-desktop mr-3"></i>Display Settings
                        </button>
                        <button onclick="showSection('notifications', this)" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md transition-colors">
                            <i class="fas fa-bell mr-3"></i>Notifications
                        </button>
                        <button onclick="showSection('data', this)" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md transition-colors">
                            <i class="fas fa-database mr-3"></i>Data Management
                        </button>
                    </nav>
                </div>

                <!-- Quick Actions -->
                <div class="card p-6 mt-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i class="fas fa-bolt text-accent mr-2"></i>
                        Quick Actions
                    </h3>
                    <div class="space-y-3">
                        <button onclick="resetToDefaults()" class="w-full btn-secondary text-sm">
                            <i class="fas fa-undo mr-2"></i>Reset to Defaults
                        </button>
                        <button onclick="exportSettings()" class="w-full btn-secondary text-sm">
                            <i class="fas fa-download mr-2"></i>Export Settings
                        </button>
                        <button onclick="importSettings()" class="w-full btn-secondary text-sm">
                            <i class="fas fa-upload mr-2"></i>Import Settings
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Settings Content -->
            <main class="flex-1 order-1 lg:order-2">
                <!-- Display Settings Section -->
                <div id="displaySection" class="settings-section">
                    <div class="card p-6 mb-6">
                        <h3 class="text-xl font-semibold text-text-primary mb-6 flex items-center">
                            <i class="fas fa-desktop text-primary mr-3"></i>
                            Display Settings
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Time Format Only -->
                            <div>
                                <label class="block text-sm font-medium text-text-primary mb-3">Time Format</label>
                                <div class="space-y-2">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="radio" name="timeFormat" value="12" class="w-4 h-4 text-primary" />
                                        <span class="text-sm text-text-primary">12-hour (2:30 PM)</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="radio" name="timeFormat" value="24" class="w-4 h-4 text-primary" />
                                        <span class="text-sm text-text-primary">24-hour (14:30)</span>
                                    </label>
                                </div>
                            </div>

                            <div class="flex items-center">
                                <p class="text-sm text-text-secondary">
                                    Time format controls how event times are displayed in your Dashboard and calendar.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div id="notificationsSection" class="settings-section hidden">
                    <div class="card p-6 mb-6">
                        <h3 class="text-xl font-semibold text-text-primary mb-6 flex items-center">
                            <i class="fas fa-bell text-primary mr-3"></i>
                            Notification Preferences
                        </h3>

                        <div class="space-y-6">
                            <!-- Browser Notifications -->
                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                <div>
                                    <h4 class="text-sm font-medium text-text-primary">Browser Notifications</h4>
                                    <p class="text-xs text-text-secondary">Allow desktop notifications for reminders</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" id="browserNotifications" />
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>

                            <!-- Default Reminder Times -->
                            <div>
                                <h4 class="text-sm font-medium text-text-primary mb-3">Default Reminder Times</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-text-secondary mb-2">Events</label>
                                        <select class="form-input text-sm" id="eventReminder">
                                            <option value="none">No reminder</option>
                                            <option value="5">5 minutes before</option>
                                            <option value="15">15 minutes before</option>
                                            <option value="30">30 minutes before</option>
                                            <option value="60">1 hour before</option>
                                            <option value="1440">1 day before</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-text-secondary mb-2">Tasks</label>
                                        <select class="form-input text-sm" id="taskReminder">
                                            <option value="none">No reminder</option>
                                            <option value="5">5 minutes before</option>
                                            <option value="15">15 minutes before</option>
                                            <option value="30">30 minutes before</option>
                                            <option value="60">1 hour before</option>
                                            <option value="1440">1 day before</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Sound Options -->
                            <div>
                                <h4 class="text-sm font-medium text-text-primary mb-3">Sound Options</h4>
                                <div class="space-y-3">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-4 h-4 text-primary" id="soundEnabled" />
                                        <span class="text-sm text-text-primary">Play notification sound</span>
                                    </label>
                                    <div class="ml-7">
                                        <select class="form-input text-sm w-48" id="soundType">
                                            <option value="default">Default</option>
                                            <option value="chime">Chime</option>
                                            <option value="bell">Bell</option>
                                            <option value="ding">Ding</option>
                                        </select>
                                        <button type="button" class="ml-2 px-3 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded transition-colors" onclick="testSound()">
                                            <i class="fas fa-play mr-1"></i>Test
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Email Notifications -->
                            <div>
                                <h4 class="text-sm font-medium text-text-primary mb-3">Email Notifications</h4>
                                <div class="space-y-3">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-4 h-4 text-primary" id="dailyEmail" />
                                        <span class="text-sm text-text-primary">Daily agenda summary</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-4 h-4 text-primary" id="weeklyEmail" />
                                        <span class="text-sm text-text-primary">Weekly schedule overview</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-4 h-4 text-primary" id="taskDeadlineEmail" />
                                        <span class="text-sm text-text-primary">Task deadline reminders</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Management Section -->
                <div id="dataSection" class="settings-section hidden">
                    <div class="card p-6 mb-6">
                        <h3 class="text-xl font-semibold text-text-primary mb-6 flex items-center">
                            <i class="fas fa-database text-primary mr-3"></i>
                            Data Management
                        </h3>

                        <div class="space-y-6">
                            <!-- Export Data -->
                            <div class="p-4 bg-slate-50 rounded-lg">
                                <h4 class="text-sm font-medium text-text-primary mb-2">Export Calendar Data</h4>
                                <p class="text-xs text-text-secondary mb-4">Download your calendar data as a backup file</p>
                                <div class="flex flex-wrap gap-3">
                                    <button onclick="exportData('json')" class="btn-secondary text-sm">
                                        <i class="fas fa-file-code mr-2"></i>Export as JSON
                                    </button>
                                    <button onclick="exportData('csv')" class="btn-secondary text-sm">
                                        <i class="fas fa-file-csv mr-2"></i>Export as CSV
                                    </button>
                                    <button onclick="exportData('ical')" class="btn-secondary text-sm">
                                        <i class="fas fa-calendar mr-2"></i>Export as iCal
                                    </button>
                                </div>
                            </div>

                            <!-- Import Data -->
                            <div class="p-4 bg-slate-50 rounded-lg">
                                <h4 class="text-sm font-medium text-text-primary mb-2">Import Calendar Data</h4>
                                <p class="text-xs text-text-secondary mb-4">Import events from a backup file or other calendar applications</p>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-3">
                                        <input type="file" id="importFile" accept=".json,.csv,.ics" class="hidden" onchange="handleFileSelect()" />
                                        <button onclick="document.getElementById('importFile').click()" class="btn-secondary text-sm">
                                            <i class="fas fa-upload mr-2"></i>Choose File
                                        </button>
                                        <span id="fileName" class="text-xs text-text-secondary">No file selected</span>
                                    </div>
                                    <button onclick="importData()" id="importBtn" class="btn-primary text-sm opacity-50 cursor-not-allowed" disabled>
                                        <i class="fas fa-download mr-2"></i>Import Data
                                    </button>
                                </div>
                            </div>

                            <!-- Storage Info -->
                            <div class="p-4 bg-slate-50 rounded-lg">
                                <h4 class="text-sm font-medium text-text-primary mb-2">Storage Information</h4>
                                <div class="space-y-2" id="storageInfo">
                                    <!-- Storage info will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Clear Data -->
                            <div class="p-4 bg-error-100 border border-error-200 rounded-lg">
                                <h4 class="text-sm font-medium text-error-600 mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    Danger Zone
                                </h4>
                                <p class="text-xs text-error-600 mb-4">These actions cannot be undone. Please be careful.</p>
                                <div class="space-y-2">
                                    <button onclick="clearAllData()" class="px-4 py-2 bg-error text-white text-sm rounded-md hover:bg-error-600 transition-colors">
                                        <i class="fas fa-trash mr-2"></i>Clear All Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save/Reset Actions -->
                <div class="card p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="text-sm text-text-secondary">
                            <i class="fas fa-info-circle mr-2"></i>
                            Use Save All or Reset Section anytime.
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="resetSection()" class="btn-secondary">
                                <i class="fas fa-undo mr-2"></i>Reset Section
                            </button>
                            <button onclick="saveAllSettings()" class="btn-primary">
                                <i class="fas fa-save mr-2"></i>Save All Settings
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 right-4 p-4 rounded-lg border shadow-lg bg-white transform translate-x-full transition-transform duration-300 z-50 max-w-sm">
        <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
                <i id="toastIcon" class="fas fa-check-circle text-success"></i>
            </div>
            <div class="flex-1">
                <p id="toastMessage" class="text-sm font-medium text-text-primary">Settings saved successfully!</p>
            </div>
            <button onclick="hideToast()" class="ml-auto text-text-secondary hover:text-text-primary">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay hidden" onclick="closeConfirmModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-text-primary">Confirm Action</h3>
                <button onclick="closeConfirmModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-6">
                <p id="confirmMessage" class="text-text-secondary">Are you sure you want to proceed?</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeConfirmModal()" class="btn-secondary">Cancel</button>
                <button id="confirmAction" onclick="executeConfirmAction()" class="px-4 py-2 bg-error text-white rounded-md hover:bg-error-600 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        let currentSection = 'display';
        let pendingAction = null;

        const defaultSettings = {
            timeFormat: '12',
            browserNotifications: true,
            eventReminder: '15',
            taskReminder: '30',
            soundEnabled: true,
            soundType: 'default',
            dailyEmail: false,
            weeklyEmail: false,
            taskDeadlineEmail: false
        };

        let settings = { ...defaultSettings };

        // Categories kept only for data export/import counts
        let categories = [
            { id: 'work', name: 'Work', color: 'blue' },
            { id: 'personal', name: 'Personal', color: 'green' },
            { id: 'health', name: 'Health', color: 'red' },
            { id: 'social', name: 'Social', color: 'purple' }
        ];

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        // ---- Settings storage ----
        function saveSettingsToStorage() {
            localStorage.setItem('schedulerSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            try {
                const stored = localStorage.getItem('schedulerSettings');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    settings = { ...defaultSettings, ...parsed };
                } else {
                    settings = { ...defaultSettings };
                    saveSettingsToStorage();
                }
            } catch (e) {
                console.error('Failed to load settings', e);
                settings = { ...defaultSettings };
            }
            applySettings();
        }

        function applySettings() {
            // Time format
            const tfRadio = document.querySelector(`input[name="timeFormat"][value="${settings.timeFormat}"]`);
            if (tfRadio) tfRadio.checked = true;
            else {
                // default to 12h if missing
                const fallback = document.querySelector('input[name="timeFormat"][value="12"]');
                if (fallback) fallback.checked = true;
            }

            // Notifications & reminder selects
            const browserNotificationsEl = document.getElementById('browserNotifications');
            const eventReminderEl = document.getElementById('eventReminder');
            const taskReminderEl = document.getElementById('taskReminder');
            const soundEnabledEl = document.getElementById('soundEnabled');
            const soundTypeEl = document.getElementById('soundType');
            const dailyEmailEl = document.getElementById('dailyEmail');
            const weeklyEmailEl = document.getElementById('weeklyEmail');
            const taskDeadlineEmailEl = document.getElementById('taskDeadlineEmail');

            if (browserNotificationsEl) browserNotificationsEl.checked = !!settings.browserNotifications;
            if (eventReminderEl) eventReminderEl.value = settings.eventReminder;
            if (taskReminderEl) taskReminderEl.value = settings.taskReminder;
            if (soundEnabledEl) soundEnabledEl.checked = !!settings.soundEnabled;
            if (soundTypeEl) soundTypeEl.value = settings.soundType;
            if (dailyEmailEl) dailyEmailEl.checked = !!settings.dailyEmail;
            if (weeklyEmailEl) weeklyEmailEl.checked = !!settings.weeklyEmail;
            if (taskDeadlineEmailEl) taskDeadlineEmailEl.checked = !!settings.taskDeadlineEmail;

            updateStorageInfo();
        }

        function saveSettings(showToastMsg = true) {
            const tf = document.querySelector('input[name="timeFormat"]:checked');
            settings.timeFormat = tf ? tf.value : defaultSettings.timeFormat;

            const browserNotificationsEl = document.getElementById('browserNotifications');
            const eventReminderEl = document.getElementById('eventReminder');
            const taskReminderEl = document.getElementById('taskReminder');
            const soundEnabledEl = document.getElementById('soundEnabled');
            const soundTypeEl = document.getElementById('soundType');
            const dailyEmailEl = document.getElementById('dailyEmail');
            const weeklyEmailEl = document.getElementById('weeklyEmail');
            const taskDeadlineEmailEl = document.getElementById('taskDeadlineEmail');

            if (browserNotificationsEl) settings.browserNotifications = browserNotificationsEl.checked;
            if (eventReminderEl) settings.eventReminder = eventReminderEl.value;
            if (taskReminderEl) settings.taskReminder = taskReminderEl.value;
            if (soundEnabledEl) settings.soundEnabled = soundEnabledEl.checked;
            if (soundTypeEl) settings.soundType = soundTypeEl.value;
            if (dailyEmailEl) settings.dailyEmail = dailyEmailEl.checked;
            if (weeklyEmailEl) settings.weeklyEmail = weeklyEmailEl.checked;
            if (taskDeadlineEmailEl) settings.taskDeadlineEmail = taskDeadlineEmailEl.checked;

            saveSettingsToStorage();

            if (showToastMsg) {
                showToast('Settings saved successfully!', 'success');
            }
        }

        function saveAllSettings() {
            saveSettings(true);
        }

        // ---- Section navigation ----
        function showSection(section, btn) {
            document.querySelectorAll('.settings-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            const sectionEl = document.getElementById(section + 'Section');
            if (sectionEl) sectionEl.classList.remove('hidden');

            document.querySelectorAll('.settings-nav-btn').forEach(b => {
                b.classList.remove('active', 'bg-primary', 'text-white');
                b.classList.add('text-text-secondary', 'hover:text-primary', 'hover:bg-slate-50');
            });

            if (btn) {
                btn.classList.add('active', 'bg-primary', 'text-white');
                btn.classList.remove('text-text-secondary', 'hover:text-primary', 'hover:bg-slate-50');
            }

            currentSection = section;

            if (section === 'data') {
                updateStorageInfo();
            }
        }

        // ---- Reset ----
        function resetSection() {
            const section = currentSection;
            showConfirmation(
                `Reset all ${section} settings to default values?`,
                () => {
                    if (section === 'display') {
                        settings.timeFormat = defaultSettings.timeFormat;
                    } else if (section === 'notifications') {
                        settings.browserNotifications = defaultSettings.browserNotifications;
                        settings.eventReminder = defaultSettings.eventReminder;
                        settings.taskReminder = defaultSettings.taskReminder;
                        settings.soundEnabled = defaultSettings.soundEnabled;
                        settings.soundType = defaultSettings.soundType;
                        settings.dailyEmail = defaultSettings.dailyEmail;
                        settings.weeklyEmail = defaultSettings.weeklyEmail;
                        settings.taskDeadlineEmail = defaultSettings.taskDeadlineEmail;
                    } else if (section === 'data') {
                        // Nothing to reset in UI, but we can refresh info
                        updateStorageInfo();
                    }

                    saveSettingsToStorage();
                    applySettings();
                    showToast(`${section.charAt(0).toUpperCase() + section.slice(1)} settings reset`, 'success');
                }
            );
        }

        function resetToDefaults() {
            showConfirmation(
                'This will reset all settings to their default values. Your events and tasks will not be deleted.',
                () => {
                    settings = { ...defaultSettings };
                    saveSettingsToStorage();
                    applySettings();
                    showToast('All settings reset to defaults', 'success');
                }
            );
        }

        // ---- Notification / Sound Test ----
        function playTestSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;

                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                let freq = 880;
                switch (settings.soundType) {
                    case 'chime':
                        freq = 660;
                        break;
                    case 'bell':
                        freq = 520;
                        break;
                    case 'ding':
                        freq = 1000;
                        break;
                    default:
                        freq = 880;
                }

                osc.type = 'sine';
                osc.frequency.value = freq;

                osc.connect(gain);
                gain.connect(ctx.destination);

                gain.gain.setValueAtTime(0.0001, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime + 0.01);

                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1);
                osc.stop(ctx.currentTime + 1);
            } catch (e) {
                console.error('Failed to play test sound', e);
            }
        }

        function testSound() {
            // Save current UI fields into settings first
            saveSettings(false);

            if (settings.browserNotifications && 'Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification('Notification Test', {
                        body: 'This is how your reminders will appear.'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification('Notification Test', {
                                body: 'This is how your reminders will appear.'
                            });
                        }
                    });
                }
            }

            if (settings.soundEnabled) {
                playTestSound();
            }

            showToast('Test notification triggered', 'info');
        }

        // ---- Data Management ----
        function updateStorageInfo() {
            const container = document.getElementById('storageInfo');
            if (!container) return;

            const events = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const settingsStr = localStorage.getItem('schedulerSettings') || '{}';

            const storageSize = (JSON.stringify(events).length + JSON.stringify(tasks).length + settingsStr.length) / 1024;

            container.innerHTML = `
                <div class="flex justify-between text-xs">
                    <span class="text-text-secondary">Events:</span>
                    <span class="text-text-primary">${Array.isArray(events) ? events.length : 0} items</span>
                </div>
                <div class="flex justify-between text-xs">
                    <span class="text-text-secondary">Tasks:</span>
                    <span class="text-text-primary">${Array.isArray(tasks) ? tasks.length : 0} items</span>
                </div>
                <div class="flex justify-between text-xs">
                    <span class="text-text-secondary">Categories:</span>
                    <span class="text-text-primary">${categories.length} items</span>
                </div>
                <div class="flex justify-between text-xs font-medium">
                    <span class="text-text-secondary">Storage Used:</span>
                    <span class="text-text-primary">${storageSize.toFixed(1)} KB</span>
                </div>
            `;
        }

        function exportData(format) {
            const events = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const data = { events, tasks, categories, settings, exportDate: new Date().toISOString() };

            let content, filename, mimeType;

            switch (format) {
                case 'json':
                    content = JSON.stringify(data, null, 2);
                    filename = `scheduler-backup-${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                    break;
                case 'csv':
                    const csvContent = [
                        'Type,Title,Date,Time,Category,Priority,Status,Description',
                        ...events.map(e => `Event,"${e.title || ''}","${e.date || ''}","${e.time || ''}","${e.category || ''}",,"","${(e.description || '').replace(/"/g, '""')}"`),
                        ...tasks.map(t => `Task,"${t.title || ''}","${t.dueDate || ''}",,"${t.category || ''}","${t.priority || ''}","${t.status || ''}","${(t.description || '').replace(/"/g, '""')}"`)
                    ].join('\n');
                    content = csvContent;
                    filename = `scheduler-data-${new Date().toISOString().split('T')[0]}.csv`;
                    mimeType = 'text/csv';
                    break;
                case 'ical':
                    const icalContent = [
                        'BEGIN:VCALENDAR',
                        'VERSION:2.0',
                        'PRODID:-//Super Scheduler//EN',
                        ...events.map(e => [
                            'BEGIN:VEVENT',
                            `UID:${e.id || (Math.random().toString(36).slice(2))}@scheduler.app`,
                            e.date && e.time ? `DTSTART:${e.date.replace(/-/g, '')}T${e.time.replace(':', '')}00` : '',
                            `SUMMARY:${e.title || ''}`,
                            `DESCRIPTION:${e.description || ''}`,
                            `CATEGORIES:${e.category || ''}`,
                            'END:VEVENT'
                        ].filter(Boolean).join('\n')),
                        'END:VCALENDAR'
                    ].join('\n');
                    content = icalContent;
                    filename = `scheduler-calendar-${new Date().toISOString().split('T')[0]}.ics`;
                    mimeType = 'text/calendar';
                    break;
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);

            showToast(`Data exported successfully as ${format.toUpperCase()}`, 'success');
        }

        function handleFileSelect() {
            const fileInput = document.getElementById('importFile');
            const fileName = document.getElementById('fileName');
            const importBtn = document.getElementById('importBtn');

            if (fileInput.files[0]) {
                fileName.textContent = fileInput.files[0].name;
                importBtn.disabled = false;
                importBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                fileName.textContent = 'No file selected';
                importBtn.disabled = true;
                importBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files[0]) {
                showToast('Please select a file to import', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.events) localStorage.setItem('calendarEvents', JSON.stringify(data.events));
                    if (data.tasks) localStorage.setItem('tasks', JSON.stringify(data.tasks));
                    if (data.categories) {
                        categories = data.categories;
                    }
                    if (data.settings) {
                        settings = { ...defaultSettings, ...data.settings };
                        saveSettingsToStorage();
                        applySettings();
                    }

                    showToast('Data imported successfully', 'success');
                    updateStorageInfo();
                } catch (error) {
                    showToast('Error importing data. Please check the file format.', 'error');
                }
            };

            reader.readAsText(file);
        }

        function clearAllData() {
            showConfirmation(
                'This will permanently delete all your calendar data including events, tasks, and settings. This action cannot be undone.',
                () => {
                    localStorage.removeItem('calendarEvents');
                    localStorage.removeItem('tasks');
                    localStorage.removeItem('schedulerSettings');

                    settings = { ...defaultSettings };
                    saveSettingsToStorage();
                    applySettings();
                    updateStorageInfo();

                    showToast('All data cleared successfully', 'success');
                }
            );
        }

        // ---- Export / Import settings only ----
        function exportSettings() {
            const data = { settings, categories, exportDate: new Date().toISOString() };
            const content = JSON.stringify(data, null, 2);
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scheduler-settings-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Settings exported successfully', 'success');
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.settings) {
                                settings = { ...defaultSettings, ...data.settings };
                                saveSettingsToStorage();
                                applySettings();
                            }
                            if (data.categories) {
                                categories = data.categories;
                            }
                            showToast('Settings imported successfully', 'success');
                        } catch (error) {
                            showToast('Error importing settings', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // ---- Confirmation modal ----
        function showConfirmation(message, action) {
            document.getElementById('confirmMessage').textContent = message;
            pendingAction = action;
            document.getElementById('confirmModal').classList.remove('hidden');
            setTimeout(() => {
                document.querySelector('#confirmModal .modal-content').classList.add('show');
            }, 10);
        }

        function closeConfirmModal(event) {
            if (event && event.target !== event.currentTarget) return;

            const modalContent = document.querySelector('#confirmModal .modal-content');
            modalContent.classList.remove('show');
            setTimeout(() => {
                document.getElementById('confirmModal').classList.add('hidden');
                pendingAction = null;
            }, 300);
        }

        function executeConfirmAction() {
            if (pendingAction) {
                pendingAction();
            }
            closeConfirmModal();
        }

        // ---- Toast ----
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');

            messageEl.textContent = message;

            icon.className = type === 'success' ? 'fas fa-check-circle text-success' :
                           type === 'error' ? 'fas fa-exclamation-circle text-error' :
                           'fas fa-info-circle text-accent';

            toast.classList.remove('translate-x-full');
            toast.classList.add('translate-x-0');

            setTimeout(() => {
                hideToast();
            }, 3000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('translate-x-0');
            toast.classList.add('translate-x-full');
        }

        // ---- Init ----
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();

            // Set initial nav active (Display)
            const displayBtn = document.querySelector('.settings-nav-btn');
            if (displayBtn) {
                displayBtn.classList.add('active', 'bg-primary', 'text-white');
                displayBtn.classList.remove('text-text-secondary', 'hover:text-primary', 'hover:bg-slate-50');
            }

            updateStorageInfo();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch (event.key) {
                    case 's':
                        event.preventDefault();
                        saveAllSettings();
                        break;
                    case 'r':
                        event.preventDefault();
                        resetSection();
                        break;
                }
            }

            if (event.key === 'Escape') {
                closeConfirmModal();
            }
        });
    </script>
</body>
</html>
