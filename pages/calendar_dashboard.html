<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendar Dashboard - Super Scheduler</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
<!-- <script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fsupersche6116back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script> -->
</head>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="bg-surface border-b border-slate-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Brand -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                        </svg>
                        <h1 class="text-xl font-semibold text-text-primary">Super Scheduler</h1>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="calendar_dashboard.html" class="text-primary font-medium px-3 py-2 rounded-md bg-primary-50">
                        <i class="fas fa-calendar-alt mr-2"></i>Dashboard
                    </a>
                    <a href="task_management.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>Tasks
                    </a>
                    <a href="search_and_filter.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-search mr-2"></i>Search
                    </a>
                </nav>

                <!-- Mobile Menu Button -->
                <button class="md:hidden p-2 rounded-md text-text-secondary hover:text-primary hover:bg-slate-50" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="md:hidden hidden border-t border-slate-200 py-4">
                <div class="flex flex-col space-y-2">
                    <a href="calendar_dashboard.html" class="text-primary font-medium px-3 py-2 rounded-md bg-primary-50">
                        <i class="fas fa-calendar-alt mr-2"></i>Dashboard
                    </a>
                    <a href="task_management.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>Tasks
                    </a>
                    <a href="search_and_filter.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-search mr-2"></i>Search
                    </a>
                    <a href="settings_and_preferences.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Sidebar -->
            <aside class="lg:w-80 order-2 lg:order-1">
                <!-- Import/Export -->
                <div class="card p-6 mb-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i class="fas fa-file-export text-secondary mr-2"></i>
                        Import/Export
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="btn-secondary flex-1 text-sm">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <button onclick="document.getElementById('importFile').click()" class="btn-secondary flex-1 text-sm">
                            <i class="fas fa-upload mr-2"></i>Import
                        </button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)" />
                </div>

                <!-- Quick Event Creation -->
                <div class="card p-6 mb-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i class="fas fa-plus-circle text-primary mr-2"></i>
                        Quick Event
                    </h3>
                    <form class="space-y-4" onsubmit="createQuickEvent(event)">
                        <div>
                            <input type="text" id="quickEventTitle" placeholder="Event title" class="form-input text-sm" required />
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="date" id="quickEventDate" class="form-input text-sm" required />
                            <input type="time" id="quickEventTime" class="form-input text-sm" required />
                        </div>
                        <div>
                            <input type="time" id="quickEventEndTime" placeholder="End time" class="form-input text-sm" required />
                        </div>
                        <div>
                            <select id="quickEventCategory" class="form-input text-sm">
                                <option value="work">Work</option>
                                <option value="personal">Personal</option>
                                <option value="health">Health</option>
                                <option value="social">Social</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary w-full text-sm">
                            <i class="fas fa-plus mr-2"></i>Add Event
                        </button>
                    </form>
                </div>

                <!-- Upcoming Tasks -->
                <div class="card p-6 mb-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i class="fas fa-clock text-accent mr-2"></i>
                        Upcoming Tasks
                    </h3>
                    <div id="upcomingTasksContainer" class="space-y-3">
                        <!-- Tasks will be populated by JavaScript -->
                    </div>
                    <a href="task_management.html" class="block mt-4 text-center text-sm text-primary hover:text-primary-700 font-medium">
                        View All Tasks <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>

                <!-- Category Filters -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i class="fas fa-filter text-secondary mr-2"></i>
                        Categories
                    </h3>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="work" onchange="filterEventsByCategory()" />
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-sm text-text-primary">Work</span>
                            <span class="text-xs text-text-secondary ml-auto category-count" data-category="work">0</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="personal" onchange="filterEventsByCategory()" />
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-sm text-text-primary">Personal</span>
                            <span class="text-xs text-text-secondary ml-auto category-count" data-category="personal">0</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="health" onchange="filterEventsByCategory()" />
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="text-sm text-text-primary">Health</span>
                            <span class="text-xs text-text-secondary ml-auto category-count" data-category="health">0</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="social" onchange="filterEventsByCategory()" />
                            <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                            <span class="text-sm text-text-primary">Social</span>
                            <span class="text-xs text-text-secondary ml-auto category-count" data-category="social">0</span>
                        </label>
                    </div>
                </div>
            </aside>

            <!-- Main Calendar Area -->
            <main class="flex-1 order-1 lg:order-2">
                <!-- Calendar Header -->
                <div class="card p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <!-- Date Navigation -->
                        <div class="flex items-center space-x-4">
                            <button onclick="navigateDate('prev')" class="p-2 rounded-md text-text-secondary hover:text-primary hover:bg-slate-50 transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h2 id="currentDate" class="text-2xl font-semibold text-text-primary">October 2025</h2>
                            <button onclick="navigateDate('next')" class="p-2 rounded-md text-text-secondary hover:text-primary hover:bg-slate-50 transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button onclick="goToToday()" class="btn-secondary text-sm">Today</button>
                        </div>

                        <!-- View Toggle -->
                        <div class="flex items-center space-x-2 bg-slate-100 rounded-lg p-1 hidden">
                            <button onclick="changeView('month')" class="view-btn active px-3 py-2 text-sm font-medium rounded-md transition-colors">
                                Month
                            </button>
                            <button onclick="changeView('week')" class="view-btn px-3 py-2 text-sm font-medium rounded-md transition-colors">
                                Week
                            </button>
                            <button onclick="changeView('day')" class="view-btn px-3 py-2 text-sm font-medium rounded-md transition-colors">
                                Day
                            </button>
                            <button onclick="changeView('agenda')" class="view-btn px-3 py-2 text-sm font-medium rounded-md transition-colors">
                                Agenda
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="card p-6">
                    <!-- Calendar Days Header -->
                    <div class="calendar-grid mb-2">
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Sun</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Mon</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Tue</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Wed</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Thu</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Fri</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Sat</div>
                    </div>

                    <!-- Calendar Body -->
                    <div id="calendarGrid" class="calendar-grid">
                        <!-- Calendar cells will be generated by JavaScript -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 right-4 p-4 rounded-lg border shadow-lg bg-white transform translate-x-full transition-transform duration-300 z-50 max-w-sm">
        <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
                <i id="toastIcon" class="fas fa-check-circle text-success"></i>
            </div>
            <div class="flex-1">
                <p id="toastMessage" class="text-sm font-medium text-text-primary">Event created successfully!</p>
            </div>
            <button onclick="hideToast()" class="ml-auto text-text-secondary hover:text-text-primary">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Event Edit Modal -->
    <div id="eventModal" class="modal-overlay hidden" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-text-primary">Edit Event</h3>
                <button onclick="closeModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form class="space-y-4" onsubmit="saveEventModal(event)" onkeydown="handleModalKeydown(event)">
                <input type="hidden" id="editEventId" />
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-1">Title</label>
                    <input type="text" id="eventTitle" class="form-input" required />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-1">Date</label>
                        <input type="date" id="eventDate" class="form-input" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-1">Time</label>
                        <input type="time" id="eventTime" class="form-input" required />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-1">End Time</label>
                    <input type="time" id="eventEndTime" class="form-input" required />
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-1">Category</label>
                    <select id="eventCategory" class="form-input">
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                        <option value="health">Health</option>
                        <option value="social">Social</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-1">Description</label>
                    <textarea id="eventDescription" class="form-input" rows="3" placeholder="Event description..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="deleteEventFromModal()" class="px-4 py-2 text-error hover:bg-error-100 rounded-md transition-colors">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                    <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentDate = new Date();
        let currentView = 'month';
        let events = [];
        let editingEventId = null;

        // Local Storage functions
        function saveEventsToStorage() {
            try {
                localStorage.setItem('calendarEvents', JSON.stringify(events));
            } catch (err) {
                console.error('Failed to save events to storage', err);
            }
        }

        function loadEventsFromStorage() {
            try {
                const stored = localStorage.getItem('calendarEvents');
                events = stored ? JSON.parse(stored) : [];
                // Defensive: ensure events is array
                if (!Array.isArray(events)) events = [];
            } catch (err) {
                console.error('Failed to load events from storage', err);
                events = [];
            }
        }

        // Event management functions
        function generateEventId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        function getCategoryColors(category) {
            const colors = {
                work: { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-500' },
                personal: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-500' },
                health: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-500' },
                social: { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-500' }
            };
            return colors[category] || colors.work;
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        // View toggle functionality
        function changeView(view) {
            const buttons = document.querySelectorAll('.view-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active', 'bg-primary', 'text-white');
                btn.classList.add('text-text-secondary', 'hover:text-primary');
            });

            // event may be undefined if called programmatically; guard
            if (window.event && window.event.target) {
                window.event.target.classList.add('active', 'bg-primary', 'text-white');
                window.event.target.classList.remove('text-text-secondary', 'hover:text-primary');
            }

            currentView = view;
            showToast(`Switched to ${view} view`, 'info');
            renderCalendar();
        }

        // Date navigation
        function navigateDate(direction) {
            if (direction === 'prev') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            updateCurrentDateDisplay();
            renderCalendar();
            showToast(`Navigated ${direction === 'prev' ? 'previous' : 'next'} month`, 'info');
        }

        function goToToday() {
            currentDate = new Date();
            updateCurrentDateDisplay();
            renderCalendar();
            showToast('Navigated to today', 'info');
        }

        function updateCurrentDateDisplay() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('currentDate').textContent =
                `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        // Calendar rendering
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date();

            for (let i = 0; i < 42; i++) { // 6 weeks * 7 days
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);

                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                cell.setAttribute('ondrop', 'dropEvent(event)');
                cell.setAttribute('ondragover', 'allowDrop(event)');
                cell.setAttribute('ondblclick', `quickCreateEvent(event, '${formatDate(cellDate)}')`);

                const dayNumber = document.createElement('div');
                dayNumber.className = cellDate.getMonth() === month
                    ? 'text-sm font-medium text-text-primary mb-2'
                    : 'text-sm text-text-secondary mb-2';
                dayNumber.textContent = cellDate.getDate();

                // Add "Today" indicator
                if (cellDate.toDateString() === today.toDateString()) {
                    const todayIndicator = document.createElement('div');
                    todayIndicator.className = 'text-sm bg-primary text-white px-2 py-1 rounded text-center font-medium mb-2';
                    todayIndicator.textContent = 'Today';
                    cell.appendChild(todayIndicator);
                }

                cell.appendChild(dayNumber);

                // Add events for this date
                const dateEvents = getEventsForDate(cellDate);
                dateEvents.forEach(event => {
                    const eventElement = createEventElement(event);
                    cell.appendChild(eventElement);
                });

                calendarGrid.appendChild(cell);
            }

            updateCategoryCounts();
        }

        function formatDate(date) {
            // Accept Date objects or ISO/date-only strings
            if (typeof date === 'string') {
                const d = new Date(date);
                if (!isNaN(d)) return d.toISOString().split('T')[0];
                // fallback for date-only 'YYYY-MM-DD'
                return date.split('T')[0];
            }
            return date.toISOString().split('T')[0];
        }

        function getEventsForDate(date) {
            const dateStr = formatDate(date);
            return events.filter(event => event.date === dateStr);
        }

        function createEventElement(event) {
            const colors = getCategoryColors(event.category);
            const eventDiv = document.createElement('div');
            eventDiv.className = `event-item ${colors.bg} ${colors.text} border-l-4 ${colors.border} cursor-pointer`;
            eventDiv.setAttribute('draggable', 'true');
            eventDiv.setAttribute('ondragstart', 'dragEvent(event)');
            eventDiv.setAttribute('onclick', `editEvent('${event.id}')`);
            eventDiv.setAttribute('data-event-id', event.id);

            // Defensive: make sure time and title exist
            const safeTitle = event.title || '(No title)';
            const safeTime = event.time || '';
            const safeEndTime = event.endTime || '';
            const timeDisplay = safeEndTime ? `${safeTime} - ${safeEndTime}` : safeTime;

            eventDiv.innerHTML = `
                <span class="text-xs font-medium">${safeTitle}</span>
                <div class="text-xs opacity-75">${timeDisplay}</div>
            `;

            return eventDiv;
        }

        // QUICK HELPERS & CONFLICT CHECKING (NEW/UPDATED)

        /**
         * hasTimeConflict(date, time, ignoreEventId = null)
         * Checks whether any existing event uses the exact same date + time.
         * If ignoreEventId is provided, that event id will be ignored (useful when editing).
         */
        function hasTimeConflict(date, time, ignoreEventId = null) {
            if (!date || !time) return false;
            const normalizedDate = date.toString().trim();
            const normalizedTime = time.toString().trim();
            return events.some(e => {
                if (!e) return false;
                if (ignoreEventId && e.id === ignoreEventId) return false;
                // defensive: ignore events with missing date/time
                if (!e.date || !e.time) return false;
                return e.date.toString().trim() === normalizedDate && e.time.toString().trim() === normalizedTime;
            });
        }

        // Quick event creation
        function quickCreateEvent(event, date) {
            event.preventDefault();
            const modal = document.getElementById('eventModal');
            document.getElementById('editEventId').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = date;
            document.getElementById('eventTime').value = '09:00';
            document.getElementById('eventEndTime').value = '10:00';
            document.getElementById('eventCategory').value = 'work';
            document.getElementById('eventDescription').value = '';

            modal.classList.remove('hidden');
            setTimeout(() => {
                document.querySelector('.modal-content').classList.add('show');
            }, 10);
        }

        function createQuickEvent(event) {
            event.preventDefault();

            const titleEl = document.getElementById('quickEventTitle');
            const dateEl = document.getElementById('quickEventDate');
            const timeEl = document.getElementById('quickEventTime');
            const endTimeEl = document.getElementById('quickEventEndTime');
            const categoryEl = document.getElementById('quickEventCategory');

            const title = titleEl.value && titleEl.value.trim();
            const date = dateEl.value && dateEl.value.trim();
            const time = timeEl.value && timeEl.value.trim();
            const endTime = endTimeEl.value && endTimeEl.value.trim();
            const category = categoryEl.value && categoryEl.value.trim();

            if (!title || !date || !time || !endTime) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            // Validate time order
            if (time >= endTime) {
                alert('Invalid Time\n\nEnd time must be after start time.\n\nPlease adjust the times and try again.');
                return;
            }

            // Conflict check (same date + same time)
            if (hasTimeConflict(date, time)) {
                if (!confirm('There is already an event at this time. Do you want to create this event anyway?')) {
                    return;
                }
            }

            const newEvent = {
                id: generateEventId(),
                title: title,
                date: date,
                time: time,
                endTime: endTime,
                category: category,
                description: ''
            };

            events.push(newEvent);
            saveEventsToStorage();
            renderCalendar();

            // Reset form
            titleEl.value = '';
            dateEl.value = '';
            timeEl.value = '';
            endTimeEl.value = '';
            categoryEl.value = 'work';

            showToast('Event created successfully!', 'success');
        }

        // Event editing
        function editEvent(eventId) {
            const ev = events.find(e => e.id === eventId);
            if (!ev) return;

            editingEventId = eventId;
            document.getElementById('editEventId').value = eventId;
            document.getElementById('eventTitle').value = ev.title || '';
            document.getElementById('eventDate').value = ev.date || '';
            document.getElementById('eventTime').value = ev.time || '';
            document.getElementById('eventEndTime').value = ev.endTime || '';
            document.getElementById('eventCategory').value = ev.category || 'work';
            document.getElementById('eventDescription').value = ev.description || '';

            document.getElementById('eventModal').classList.remove('hidden');
            setTimeout(() => {
                document.querySelector('.modal-content').classList.add('show');
            }, 10);
        }

        function saveEventModal(event) {
            event.preventDefault();
            const eventId = document.getElementById('editEventId').value;
            const title = document.getElementById('eventTitle').value && document.getElementById('eventTitle').value.trim();
            const date = document.getElementById('eventDate').value && document.getElementById('eventDate').value.trim();
            const time = document.getElementById('eventTime').value && document.getElementById('eventTime').value.trim();
            const endTime = document.getElementById('eventEndTime').value && document.getElementById('eventEndTime').value.trim();
            const category = document.getElementById('eventCategory').value && document.getElementById('eventCategory').value.trim();
            const description = document.getElementById('eventDescription').value || '';

            if (!title || !date || !time || !endTime) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            // Validate time order
            if (time >= endTime) {
                alert('Invalid Time\n\nEnd time must be after start time.\n\nPlease adjust the times and try again.');
                return;
            }

            // If updating existing event
            if (eventId) {
                const eventIndex = events.findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    // Conflict check ignoring the event being edited
                    if (hasTimeConflict(date, time, eventId)) {
                        if (!confirm('There is already an event at this time. Do you want to update this event anyway?')) {
                            return;
                        }
                    }

                    events[eventIndex] = {
                        ...events[eventIndex],
                        title,
                        date,
                        time,
                        endTime,
                        category,
                        description
                    };
                    showToast('Event updated successfully!', 'success');
                }
            } else {
                // Creating new event from modal
                // Conflict check
                if (hasTimeConflict(date, time)) {
                    if (!confirm('There is already an event at this time. Do you want to create this event anyway?')) {
                        return;
                    }
                }

                const newEvent = {
                    id: generateEventId(),
                    title,
                    date,
                    time,
                    endTime,
                    category,
                    description
                };
                events.push(newEvent);
                showToast('Event created successfully!', 'success');
            }

            saveEventsToStorage();
            renderCalendar();
            closeModal();
        }

        function deleteEventFromModal() {
            const eventId = document.getElementById('editEventId').value;
            if (!eventId) return;

            if (confirm('Are you sure you want to delete this event?')) {
                events = events.filter(e => e.id !== eventId);
                saveEventsToStorage();
                renderCalendar();
                showToast('Event deleted successfully', 'success');
                closeModal();
            }
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;

            document.querySelector('.modal-content').classList.remove('show');
            setTimeout(() => {
                document.getElementById('eventModal').classList.add('hidden');
            }, 300);
        }

        function handleModalKeydown(event) {
            // Submit form when Enter is pressed (except in textarea)
            if (event.key === 'Enter' && event.target.tagName !== 'TEXTAREA') {
                event.preventDefault();
                saveEventModal(event);
            }
        }

        // Drag and drop functionality
        function dragEvent(event) {
            const eventElement = event.target.closest('.event-item');
            event.dataTransfer.setData('text/plain', eventElement.getAttribute('data-event-id'));
            eventElement.classList.add('drag-ghost');
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drop-zone', 'active');
        }

        function dropEvent(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drop-zone', 'active');

            const eventId = event.dataTransfer.getData('text/plain');
            const eventObj = events.find(e => e.id === eventId);
            if (!eventObj) return;

            // Get the target date from the calendar cell
            const cell = event.currentTarget;
            const dayElement = cell.querySelector('.text-text-primary, .text-text-secondary');
            if (!dayElement) return;

            const day = parseInt(dayElement.textContent);
            const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const newDateStr = formatDate(newDate);

            // Conflict: if target date + existing time slot already taken by another event (not this one), ask user
            if (hasTimeConflict(newDateStr, eventObj.time, eventObj.id)) {
                if (!confirm('There is already an event at this time on this day. Do you want to reschedule anyway?')) {
                    renderCalendar(); // Re-render to reset the dragged event position
                    return;
                }
            }

            // Update event date
            eventObj.date = newDateStr;
            saveEventsToStorage();
            renderCalendar();

            showToast('Event rescheduled successfully', 'success');
        }

        // Category filtering
        function filterEventsByCategory() {
            // If no category checkboxes are present, just return
            const checkboxes = document.querySelectorAll('.category-filter');
            if (!checkboxes || checkboxes.length === 0) return;

            const checkedCategories = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.category);

            // Hide/show events based on category filters
            document.querySelectorAll('.event-item').forEach(eventElement => {
                const eventId = eventElement.getAttribute('data-event-id');
                const ev = events.find(e => e.id === eventId);
                if (ev && checkedCategories.includes(ev.category)) {
                    eventElement.style.display = 'block';
                } else {
                    eventElement.style.display = 'none';
                }
            });
        }

        function updateCategoryCounts() {
            const categoryCounts = {
                work: events.filter(e => e.category === 'work').length,
                personal: events.filter(e => e.category === 'personal').length,
                health: events.filter(e => e.category === 'health').length,
                social: events.filter(e => e.category === 'social').length
            };

            Object.entries(categoryCounts).forEach(([category, count]) => {
                const countElement = document.querySelector(`.category-count[data-category="${category}"]`);
                if (countElement) {
                    countElement.textContent = count;
                }
            });
        }

        // Storage listener: if tasks/events changed in other tabs, refresh UI
        window.addEventListener('storage', function(e) {
            if (!e) return;
            if (e.key === 'calendarEvents') {
                loadEventsFromStorage();
                renderCalendar();
            }
        });

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');

            if (!toast || !messageEl || !icon) return;

            messageEl.textContent = message;

            // Set icon based on type
            icon.className = type === 'success' ? 'fas fa-check-circle text-success' :
                           type === 'error' ? 'fas fa-exclamation-circle text-error' :
                           'fas fa-info-circle text-accent';

            // Show toast
            toast.classList.remove('translate-x-full');
            toast.classList.add('translate-x-0');

            setTimeout(() => {
                hideToast();
            }, 3000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.classList.remove('translate-x-0');
            toast.classList.add('translate-x-full');
        }

        // Import/Export functions
        function exportData() {
            try {
                // Get all events and tasks
                const eventsData = localStorage.getItem('calendarEvents');
                const tasksData = localStorage.getItem('tasks');
                
                const exportObj = {
                    events: eventsData ? JSON.parse(eventsData) : [],
                    tasks: tasksData ? JSON.parse(tasksData) : [],
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                // Create download
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `calendar-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast('Data exported successfully!', 'success');
            } catch (err) {
                console.error('Export failed', err);
                showToast('Failed to export data', 'error');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importObj = JSON.parse(e.target.result);
                    
                    // Validate structure
                    if (!importObj.events || !importObj.tasks) {
                        showToast('Invalid file format', 'error');
                        return;
                    }

                    // Confirm before overwriting
                    if (!confirm('This will replace all current events and tasks. Continue?')) {
                        return;
                    }

                    // Import data
                    localStorage.setItem('calendarEvents', JSON.stringify(importObj.events));
                    localStorage.setItem('tasks', JSON.stringify(importObj.tasks));
                    
                    // Reload UI
                    loadEventsFromStorage();
                    renderCalendar();

                    showToast(`Imported ${importObj.events.length} events and ${importObj.tasks.length} tasks`, 'success');
                } catch (err) {
                    console.error('Import failed', err);
                    showToast('Failed to import data - invalid JSON', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case 't':
                        event.preventDefault();
                        window.location.href = 'task_management.html';
                        break;
                    case 'f':
                        event.preventDefault();
                        window.location.href = 'search_and_filter.html';
                        break;
                }
            }

            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Initialize calendar
        document.addEventListener('DOMContentLoaded', function() {
            loadEventsFromStorage();
            updateCurrentDateDisplay();
            renderCalendar();

            // Set default date for quick event form to today
            const today = new Date().toISOString().split('T')[0];
            const quickDateEl = document.getElementById('quickEventDate');
            if (quickDateEl) quickDateEl.value = today;

            // Set initial view
            const monthBtn = document.querySelector('.view-btn');
            if (monthBtn) monthBtn.classList.add('active', 'bg-primary', 'text-white');

            // Add event listeners for drag and drop cleanup
            document.addEventListener('dragend', function(event) {
                document.querySelectorAll('.event-item').forEach(eventElement => {
                    eventElement.classList.remove('drag-ghost');
                });
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.classList.remove('drop-zone', 'active');
                });
            });

            // Defensive: re-render when we get focus in case other tab changed storage
            window.addEventListener('focus', () => {
                loadEventsFromStorage();
                renderCalendar();
            });
        });
    </script>
</body>
</html>
